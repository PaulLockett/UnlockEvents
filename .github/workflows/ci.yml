name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint-format-typecheck:
    name: Lint, Format, Typecheck
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Check formatting
        run: pnpm format:check

      - name: Lint
        run: pnpm lint

      - name: Typecheck
        run: pnpm typecheck

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: lint-format-typecheck

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run tests
        run: pnpm test
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          EXA_API_KEY: ${{ secrets.EXA_API_KEY }}
          HONCHO_API_KEY: ${{ secrets.HONCHO_API_KEY }}

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: lint-format-typecheck

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build all packages and services
        run: pnpm build

  # Railway PR environments are created automatically by Railway's GitHub integration
  # when a PR targets the trigger branch (main). Railway forks the base environment
  # (production) and deploys the PR branch into it.
  #
  # This job polls for Railway commit statuses and reports success/failure.
  # On the first PR (before services exist on main), Railway won't create
  # a PR environment — the job will complete with a warning.
  railway-preview:
    name: Railway Preview
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'pull_request'

    steps:
      - name: Wait for Railway deployment
        uses: actions/github-script@v7
        with:
          script: |
            const maxAttempts = 15;
            const delayMs = 20000;

            core.info('Polling for Railway deployment commit statuses...');

            for (let attempt = 1; attempt <= maxAttempts; attempt++) {
              const { data: statuses } = await github.rest.repos.listCommitStatusesForRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: context.payload.pull_request.head.sha,
              });

              const railwayStatuses = statuses.filter(s =>
                s.context.toLowerCase().includes('railway')
              );

              if (railwayStatuses.length > 0) {
                const allDone = railwayStatuses.every(s =>
                  s.state === 'success' || s.state === 'failure' || s.state === 'error'
                );
                const anyFailed = railwayStatuses.some(s =>
                  s.state === 'failure' || s.state === 'error'
                );

                if (allDone) {
                  for (const status of railwayStatuses) {
                    core.info(`${status.context}: ${status.state} — ${status.target_url || 'no URL'}`);
                  }
                  if (anyFailed) {
                    core.setFailed('One or more Railway deployments failed');
                  } else {
                    core.info('All Railway deployments succeeded');
                  }
                  return;
                }

                core.info(`[${attempt}/${maxAttempts}] Railway deploying... (${railwayStatuses.map(s => `${s.context}=${s.state}`).join(', ')})`);
              } else {
                core.info(`[${attempt}/${maxAttempts}] No Railway statuses yet...`);
              }

              if (attempt < maxAttempts) {
                await new Promise(resolve => setTimeout(resolve, delayMs));
              }
            }

            core.warning('Railway deployment status not detected within 5 minutes. This is expected on the first PR before services exist on main.');

  # Migration validation is handled by Supabase's GitHub integration
  # (shows as "Supabase Preview" check on PRs)
